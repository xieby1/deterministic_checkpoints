<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>❄ 确定性负载（Deterload）❄</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">入门（Get Started）</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 🏠README.md</a></li><li class="chapter-item expanded "><a href="examples.html"><strong aria-hidden="true">2.</strong> 🎮例子（Examples）</a></li><li class="chapter-item expanded affix "><li class="part-title">设计（Design）</li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">3.</strong> 🌏概览（Overview）</a></li><li class="chapter-item expanded "><a href="config.html"><strong aria-hidden="true">4.</strong> 🧾配置（Configurations）</a></li><li class="chapter-item expanded "><a href="benchmarks/index.html"><strong aria-hidden="true">5.</strong> 📈基准测试（Benchmarks）</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="benchmarks/openblas.html"><strong aria-hidden="true">5.1.</strong> OpenBLAS</a></li><li class="chapter-item expanded "><a href="benchmarks/spec2006.html"><strong aria-hidden="true">5.2.</strong> SPEC CPU 2006</a></li></ol></li><li class="chapter-item expanded "><a href="builders/index.html"><strong aria-hidden="true">6.</strong> 🔨构建器（Builders）</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="builders/imgBuilder.html"><strong aria-hidden="true">6.1.</strong> 镜像构建器（Image Builder）</a></li><li class="chapter-item expanded "><a href="builders/cptBuilder.html"><strong aria-hidden="true">6.2.</strong> 切片构建器（Checkpoint Builder）</a></li></ol></li><li class="chapter-item expanded "><a href="outputs/index.html"><strong aria-hidden="true">7.</strong> 📊输出（Outputs）</a></li><li class="chapter-item expanded "><a href="running/index.html"><strong aria-hidden="true">8.</strong> 💽运行输出的镜像（Running Output Images）</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="running/emulators.html"><strong aria-hidden="true">8.1.</strong> 仿真器（Emulators）</a></li><li class="chapter-item expanded "><a href="running/gem5.html"><strong aria-hidden="true">8.2.</strong> GEM5</a></li><li class="chapter-item expanded "><a href="running/nemu.html"><strong aria-hidden="true">8.3.</strong> NEMU</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">参考（Reference）</li><li class="chapter-item expanded "><a href="reference/config.html"><strong aria-hidden="true">9.</strong> 🧾可配参数（Configurable Arguments）</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">❄ 确定性负载（Deterload）❄</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/OpenXiangShan/Deterload" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="确定性负载deterload"><a class="header" href="#确定性负载deterload">确定性负载（Deterload）</a></h1>
<p><strong>确定性负载</strong>（Deterload）是一个为香山生态（包括
<a href="https://docs.xiangshan.cc">香山处理器</a>、
<a href="https://github.com/OpenXiangShan/NEMU">香山NEMU</a>
和<a href="https://github.com/OpenXiangShan/GEM5">香山GEM5</a>
）生成<strong>确定性工作负载</strong>的框架。</p>
<p><strong>Deterload</strong> is a framework for generating <strong>Deterministic Workloads</strong> for the XiangShan ecosystem (including
<a href="https://github.com/OpenXiangShan/XiangShan">XiangShan Processor</a>,
<a href="https://github.com/OpenXiangShan/NEMU">XiangShan NEMU</a>,
and <a href="https://github.com/OpenXiangShan/GEM5">XiangShan GEM5</a>
).</p>
<h2 id="背景background"><a class="header" href="#背景background">背景（Background）</a></h2>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">香山</a>是一款开源的高性能RISC-V处理器，其核心理念是敏捷开发。
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">香山的工作负载</a>指运行在香山处理器上的各类程序，是开发、调试、评估、研究时不可或缺的组件。</p>
<p><a href="https://github.com/OpenXiangShan/XiangShan/">XiangShan</a> is an open-source high-performance RISC-V processor, built around the core concept of agile development.
<a href="https://docs.xiangshan.cc/zh-cn/latest/workloads/overview/">XiangShan's workloads</a> refer to various programs running on XiangShan processor,
which are essential components for development, debugging, evaluation, and research.</p>
<p>为了能更加敏捷地生成各类工作负载，我们开发了Deterload项目。
Deterload在<a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a>框架上，引入了<strong>确定性</strong>。
此外，Deterload不仅支持生成切片镜像，还计划支持香山的各类工作负载，包括非切片镜像和裸机镜像。</p>
<p>To enable more agile generation of various workloads, we developed the Deterload project.
Deterload is based on the <a href="https://github.com/xyyy1420/checkpoint_scripts">checkpoint_scripts</a> framework and adds the <strong>deterministic</strong> feature.
Moreover, Deterload not only supports generating checkpoint images but also plans to support various workloads for XiangShan, including non-checkpoint images and bare-metal images.</p>
<h2 id="关于确定性about-deterministic"><a class="header" href="#关于确定性about-deterministic">关于“确定性”（About "Deterministic"）</a></h2>
<p>🤔<strong>什么</strong>是“确定性”？
😺无论何时何地，两次构建同一个工作负载，都应该得到完全相同的结果！</p>
<p>🤔<strong>为什么</strong>需要“确定性”？
😺它能让开发更敏捷。无论何时何地，你都能轻松重现bug和性能异常！</p>
<p>🤔<strong>如何</strong>实现“确定性”？
😺使用确定性包管理器<a href="https://nixos.org/">Nix</a>并且控制所有随机性！</p>
<p>🤔<strong>What</strong> is "Deterministic"?
😺It means that whenever and wherever building the workload twice should yield the same result!</p>
<p>🤔<strong>Why</strong> do we need "Deterministic"?
😺It enables more agile development.
You can reproduce bugs and performance anomalies anytime, anywhere, without hassle!</p>
<p>🤔<strong>How</strong> to achieve "Deterministic"?
😺Using the deterministic package manager <a href="https://nixos.org/">Nix</a> and controlling all possible sources of randomness!</p>
<h2 id="使用方法usage"><a class="header" href="#使用方法usage">使用方法（Usage）</a></h2>
<p>Deterload由Nix驱动。
如果你尚未安装Nix，请参考<a href="https://nixos.org/download/">Nix官方安装指南</a>。</p>
<p>Deterload is powered by Nix.
If you haven't installed Nix, please refer to the <a href="https://nixos.org/download/">Nix official installation</a>.</p>
<pre><code class="language-bash"># 进入nix shell（推荐使用direnv自动进入nix shell）：
# Enter the nix shell (direnv is recommended for auto entering the nix shell):
nix-shell

# 用10个线程为&lt;benchmark&gt;生成切片，切片存于result/：
# Generate checkpoints for &lt;benchmark&gt; using 10 threads, saved in result/:
nom-build -A &lt;benchmark&gt;.cpt -j10

# 通过命令行开启编译器的自动向量化，为&lt;benchmark&gt;生成切片，切片存于result/：
# Enable compiler's auto vectorization by CLI, generate checkpoints for &lt;benchmark&gt;, saved in result/:
nom-build --arg enableVector true -A &lt;benchmark&gt;.cpt

# 或者通过配置文件开启编译器的自动向量化，为&lt;benchmark&gt;生成切片，切片存于result/：
# Or enable compiler's auto vectorization by a config file, generate checkpoints for &lt;benchmark&gt;, saved in result/:
nom-build examples/vector.nix -A &lt;benchmark&gt;.cpt

# 显示帮助信息：
# Display help information:
h
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="例子examples"><a class="header" href="#例子examples">🎮例子（Examples）</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="概览overview"><a class="header" href="#概览overview">🌏概览（Overview）</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="配置configurations"><a class="header" href="#配置configurations">🧾配置（Configurations）</a></h1>
<p>TODO:</p>
<p>Deterload支持多种配置方式：</p>
<ul>
<li>命令行</li>
<li>配置文件</li>
<li>命令行+配置文件</li>
</ul>
<h2 id="命令行"><a class="header" href="#命令行">命令行</a></h2>
<p>通过<code>--arg key value</code>的方式传递配置。例如：</p>
<pre><code class="language-bash">nix-build --arg enableVector true --arg simulator '"qemu"' -A openblas.cpt
</code></pre>
<p>可以用<code>--argstr key value</code>来简化<code>--arg key '"value"'</code>：</p>
<pre><code class="language-bash">nix-build --arg enableVector true --argstr simulator qemu -A openblas.cpt
</code></pre>
<h2 id="配置文件"><a class="header" href="#配置文件">配置文件</a></h2>
<h2 id="命令行配置文件"><a class="header" href="#命令行配置文件">命令行+配置文件</a></h2>
<h2 id="可配参数configurable-arguments"><a class="header" href="#可配参数configurable-arguments"><a href="./reference/config.html">🧾可配参数（Configurable Arguments）</a></a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="基准测试benchmarks"><a class="header" href="#基准测试benchmarks">📈基准测试（Benchmarks）</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openblas"><a class="header" href="#openblas">OpenBLAS</a></h1>
<div style="break-before: page; page-break-before: always;"></div><p>TODO:</p>
<h2 id="preparing-spec-cpu2006-source-code"><a class="header" href="#preparing-spec-cpu2006-source-code">Preparing SPEC CPU2006 Source Code</a></h2>
<p>Before using this project, you need to prepare the SPEC CPU2006 program source code yourself. Please follow these steps:</p>
<ol>
<li>Obtain the SPEC CPU2006 source code (we cannot provide the source code due to licensing restrictions).</li>
<li>It is recommended to store the SPEC CPU2006 source code directory separately, not in the same location as this repository.</li>
<li>Rename the obtained source code folder to "spec2006", like ~/workspace/spec2006.</li>
<li>Please do not modify the SPEC CPU2006 source code, as this may cause the build to fail.</li>
<li>Note that the spec2006/default.nix directory in this repository is different from the SPEC CPU2006 source code directory. The former can be considered as a Nix build script.</li>
</ol>
<p>Note: Generating checkpoints may take several or more than ten hours, depending on the complexity of the benchmark.</p>
<p>Please note that the build process may take a considerable amount of time:</p>
<ol>
<li>
<p>First, the script will fetch and compile the RISC-V GCC toolchain, Linux kernel, QEMU, and other necessary components. This step takes approximately 1 hour.</p>
</li>
<li>
<p>Then, it will use QEMU for profiling, SimPoint sampling, and QEMU checkpoint generation. Generating spec2006 ref input checkpoint typically requires about 10 hours.</p>
</li>
</ol>
<p>If you want to quickly test the system, you can start by setting the input size to "test":</p>
<ol>
<li>Edit the <code>conf.nix</code> file</li>
<li>Change <code>size = xxx</code> to <code>size = "test"</code></li>
</ol>
<p>With the test input size, the entire process should complete in about 30 minutes.</p>
<p>Finally, it will generate a result folder, you will get all the checkpoints in the result folder</p>
<p>If you want to back up some checkpoints:
run</p>
<pre><code class="language-bash">nom-build -j 30
python3 backup_checkpoints.py
</code></pre>
<p>It will copy checkpoints from nix path to local pwd path, named backup_XXX (timestamp).
Notice: backup_XXX is about 100GB!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="构建框架builders"><a class="header" href="#构建框架builders">🔨构建框架（Builders）</a></h1>
<p><img src="builders/./images/overview_py.svg" alt="" /></p>
<p><img src="builders/./images/deps_py.svg" alt="" /></p>
<p>TODO:</p>
<p>The project uses Nix to manage dependencies and build the necessary components:</p>
<ul>
<li>QEMU: Modified version of QEMU with checkpoint and profiling capabilities</li>
<li>Simpoint: Simpoint is a tool for profiling and checkpointing in XiangShan</li>
<li>OpenSBI: RISC-V OpenSBI firmware</li>
<li>Linux: Custom Linux kernel image</li>
<li>Profiling tools: Scripts and plugins for analyzing checkpoint data</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="镜像构建器image-builder"><a class="header" href="#镜像构建器image-builder">镜像构建器（Image Builder）</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="切片构建器checkpoint-builder"><a class="header" href="#切片构建器checkpoint-builder">切片构建器（Checkpoint Builder）</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="输出outputs"><a class="header" href="#输出outputs">📊输出（Outputs）</a></h1>
<p>下面的表格展示了Deterload的构建结果，具体说明如下：</p>
<ul>
<li><code>Date</code>行表示构建开始的时间，格式为年月日时分秒(yymmddhhmmss)。
各列按照<code>Date</code>降序排列（最新排最前面）。</li>
<li><code>Commit</code>行显示每次构建对应的Git commit的哈希值。</li>
<li><code>Note</code>行包含简单的说明（主要是说明为什么哈希值发生变化）。</li>
<li><code>result/</code>行及其下方的行表示构建结果的Nix store哈希值。
每个单元格都用颜色标记，不同的颜色表示不同的哈希值。
通过这种颜色标记，可以轻松看出多次构建之间是否保持了<strong>确定性</strong>。</li>
</ul>
<p>The tables below demonstrate the build results of Deterload, with the following details:</p>
<ul>
<li>The <code>Date</code> row indicates the build start time in yymmddhhmmss format.
Columns are sorted by <code>Date</code> in descending order (most recent first).</li>
<li>The <code>Commit</code> row displays the Git commit hash associated with each build.</li>
<li>The <code>Note</code> row shows a simple explanation (mainly explains why hash changed).</li>
<li>The <code>result/</code> row and the subsequent rows indicates the Nix store hashes of build results.
Each cell is color-coded, with different colors indicating distinct hash values.
This color coding makes it straightforward to verify <strong>deterministic</strong> build across multiple builds.</li>
</ul>
<h2 id="spec2006"><a class="header" href="#spec2006">SPEC2006</a></h2>
<div style="width: var(--content-max-width); overflow: auto;">
<div id="spec2006Table"></div>
</div>
<h2 id="openblas-1"><a class="header" href="#openblas-1">OpenBLAS</a></h2>
<div style="width: var(--content-max-width); overflow: auto;">
<div id="openblasTable"></div>
</div>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="./gen_table.js"></script>
<script>
gen_table("spec2006Table", "https://raw.githubusercontent.com/OpenXiangShan/Deterload/refs/heads/data/spec2006.txt")
gen_table("openblasTable", "https://raw.githubusercontent.com/OpenXiangShan/Deterload/refs/heads/data/openblas.txt")
</script>
<div style="break-before: page; page-break-before: always;"></div><h1 id="运行输出的镜像running-output-images"><a class="header" href="#运行输出的镜像running-output-images">💽运行输出的镜像（Running Output Images）</a></h1>
<p>TODO:</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="仿真器emulators"><a class="header" href="#仿真器emulators">仿真器（Emulators）</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h2 id="running-on-gem5"><a class="header" href="#running-on-gem5">Running on Gem5</a></h2>
<p>The checkpoints generated by this repository can be run on Gem5, Nemu, and XiangShan RTL in the XiangShan repository. Here we explain the considerations for running on Gem5.</p>
<p>Since the checkpoints in this repository are currently single-core and without V extension (will be updated once vector extension support is stable), please configure according to the README in https://github.com/OpenXiangShan/GEM5.</p>
<p>Note: This repository's checkpoints by default place the checkpoint restorer code at the beginning of the checkpoint address space (refer to opensbi/default.nix). Therefore, there's no need to specify the $GCB_RESTORER environment variable; you can set it to empty.</p>
<p>If you encounter difftest errors during Gem5 execution, you can follow these steps:</p>
<ol>
<li>Visit the Gem5 releases page</li>
<li>Download a stable version of NEMU</li>
<li>Set the corresponding <code>$GCBV_REF_SO</code> environment variable</li>
</ol>
<p>This approach can help resolve difftest errors and ensure proper execution of checkpoints on Gem5.</p>
<p>If you encounter other Gem5 runtime errors, try debugging by adding <code>gdb --args</code> before the gem5 command. You can also open an issue in this repository or the Gem5 repository.</p>
<p>Please note that some checkpoints may fail to run in Gem5. This issue is currently being addressed. However, over 90% of the checkpoints should run correctly, and the resulting scores should be generally accurate. After running all checkpoints in Gem5, you can use the following script to calculate the SPEC CPU 2006 slice scores:</p>
<p>https://github.com/shinezyy/gem5_data_proc</p>
<p>You may need to make some minor modifications to this repository, as gem5_data_proc is designed for internal checkpoints, and there are slight differences in file naming between it and the Nix checkpoints. For example, "hmmer" vs "456.hmmer".</p>
<p>This script can help you process the data generated by Gem5 and calculate the final scores for the SPEC CPU 2006 benchmark. Even if a few checkpoints fail to run, this script should still provide you with a fairly accurate performance assessment.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nemu"><a class="header" href="#nemu">NEMU</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="可配参数configurable-arguments-1"><a class="header" href="#可配参数configurable-arguments-1">🧾可配参数（Configurable Arguments）</a></h1>
<style>
arg {
  font-family: mono;
  font-size: 1.2em;
  font-weight: bold;
}
arg::before {
  content: "• "
}
</style>
<h2 id="common-configuration"><a class="header" href="#common-configuration">Common Configuration</a></h2>
<p><arg>cc</arg>: Compiler Collection used for compiling RISC-V binaries.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"gcc14"</code></li>
<li><strong>Available values</strong>: Prefix of any nixpkgs-supported <u>xxx</u>Stdenv.
To list available <u>xxx</u>Stdenv:
<pre><code class="language-bash">nix-instantiate --eval -E 'let pkgs=import &lt;nixpkgs&gt; {}; in builtins.filter (x: pkgs.lib.hasSuffix "Stdenv" x)(builtins.attrNames pkgs)'
</code></pre>
</li>
<li><strong>TODO</strong>: Currently only supports GCC's stdenv.
LLVM's fortran compiler (flang) is needed to support Clang's stdenv.
Preliminary experiments with riscv64-jemalloc show that Clang provides better auto-vectorization than GCC.</li>
</ul>
<h2 id="benchmarks-configuration"><a class="header" href="#benchmarks-configuration">Benchmarks Configuration</a></h2>
<h3 id="benchmarks-common-configuration"><a class="header" href="#benchmarks-common-configuration">Benchmarks Common Configuration</a></h3>
<p><arg>enableVector</arg>: Controls compiler's auto-vectorization during benchmark builds.</p>
<ul>
<li><strong>Type</strong>: bool</li>
<li><strong>Default value</strong>: <code>false</code></li>
</ul>
<h3 id="spec-cpu-2006-configuration"><a class="header" href="#spec-cpu-2006-configuration">SPEC CPU 2006 Configuration</a></h3>
<p><arg>spec2006-extra-tag</arg>: Extra tag for SPEC CPU 2006 output names.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>""</code></li>
<li><strong>Example</strong>:
Setting <code>spec2006-extra-tag = "miao"</code>,
the checkpoint name changes from <code>spec2006_ref_..._1core_cpt</code> to <code>spec2006_ref_..._1core_miao_cpt</code>.</li>
</ul>
<p><arg>spec2006-src</arg>: Path to SPEC CPU 2006 source code.</p>
<ul>
<li><span style="background-color:yellow;"><strong>Note</strong></span>:
As SPEC CPU 2006 is a proprietary benchmark, it cannot be incorporated in Deterload's source code.
You need to obatin the its source code through legal means.</li>
<li><strong>Type</strong>: path</li>
<li><strong>Supported path types</strong>:
<ul>
<li>
<p>Path to a folder:</p>
<p>The folder must be the root directory of the SPEC CPU 2006 source code.</p>
<p>Example:</p>
<pre><code class="language-nix">spec2006-src = /path/miao/spec2006;
</code></pre>
<p>Required folder structure:</p>
<pre><code>/path/miao/spec2006
├── benchspec/
├── bin/
├── tools/
├── shrc
...
</code></pre>
</li>
<li>
<p>Path to a tar file:</p>
<p>The tar file must contain a folder named exactly <code>spec2006</code>,
with the same folder structure as above.</p>
<p>Supported tar file extensions:</p>
<ul>
<li>gzip (.tar.gz, .tgz or .tar.Z)</li>
<li>bzip2 (.tar.bz2, .tbz2 or .tbz)</li>
<li>xz (.tar.xz, .tar.lzma or .txz)</li>
</ul>
<p>Example:</p>
<pre><code class="language-nix">spec2006-src = /path/of/spec2006.tar.gz;
</code></pre>
</li>
<li>
<p>For more information about supported path types,
please see <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-unpack-phase">Nixpkgs Manual: The unpack phase</a>.</p>
</li>
</ul>
</li>
</ul>
<p><arg>spec2006-size</arg>: Input size for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"ref"</code></li>
<li><strong>Available values</strong>: <code>"ref"</code>, <code>"train"</code>, <code>"test"</code></li>
</ul>
<p><arg>spec2006-optimize</arg>: Compiler optimization flags for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"-O3 -flto"</code></li>
</ul>
<p><arg>spec2006-march</arg>: Compiler's <code>-march</code> option for SPEC CPU 2006.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: "rv64gc${lib.optionalString enableVector "v"}_zba_zbb_zbc_zbs"</li>
<li><strong>Description</strong>: The default value depends on <code>enableVector</code>:
<ul>
<li>If <code>enableVector</code> is <code>true</code>, the default value is <code>"rv64gc_zba_zbb_zbc_zbs"</code>,</li>
<li>If <code>enableVector</code> is <code>false</code>, the default value is <code>"rv64gcv_zba_zbb_zbc_zbs"</code>.</li>
</ul>
</li>
</ul>
<p><arg>spec2006-testcase-filter</arg>: Function to filter SPEC CPU 2006 testcases.</p>
<ul>
<li><strong>Type</strong>: string -&gt; bool</li>
<li><strong>Default value</strong>: <code>testcase: true</code></li>
<li><strong>Description</strong>: <code>spec2006-testcase-filter</code> takes a testcase name as input and returns:
<ul>
<li><code>true</code>: include this testcase</li>
<li><code>false</code>: exclude this testcase</li>
</ul>
</li>
<li><strong>Example 1</strong>: Include all testcases:
<pre><code class="language-nix">spec2006-testcase-filter = testcase: true;
</code></pre>
</li>
<li><strong>Example 2</strong>: Only include <code>403_gcc</code>:
<pre><code class="language-nix">spec2006-testcase-filter = testcase: testcase == "403_gcc";
</code></pre>
</li>
<li><strong>Example 3</strong>: Exlcude <code>464_h264ref</code> and <code>465_tonto</code>:
<pre><code class="language-nix">spec2006-testcase-filter = testcase: !(builtins.elem testcase [
  "464_h264ref"
  "465_tonto"
]);
</code></pre>
</li>
</ul>
<h3 id="openblas-configuration"><a class="header" href="#openblas-configuration">OpenBLAS Configuration</a></h3>
<p><arg>openblas-extra-tag</arg>: Extra tag for OpenBLAS output names.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>""</code></li>
<li><strong>Description</strong>:
Setting <code>openblas-extra-tag = "miao"</code>,
the checkpoint name changes from <code>openblas_ref_..._1core_cpt</code> to <code>openblas_ref_..._1core_miao_cpt</code>.</li>
</ul>
<p><arg>openblas-target</arg>: CPU TARGET for OpenBLAS.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>if enableVector then "RISCV64_ZVL128B" else "RISCV64_GENERIC"</code></li>
<li><strong>Available values</strong>: <code>"RISCV64_GENERIC"</code>, <code>"RISCV64_ZVL128B"</code>, <code>"RISCV64_ZVL256B"</code></li>
<li><strong>Description</strong>: The default value depends on <code>enableVector</code>:
<ul>
<li>If <code>enableVector</code> is <code>true</code>, the default value is <code>"RISCV64_ZVL128B"</code>,</li>
<li>If <code>enableVector</code> is <code>false</code>, the default value is <code>"RISCV64_GENERIC"</code>.</li>
</ul>
</li>
</ul>
<h2 id="builders-configuration"><a class="header" href="#builders-configuration">Builders Configuration</a></h2>
<p><arg>cpt-maxK</arg>: maxK value for all benchmarks in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: number-in-string</li>
<li><strong>Default value</strong>: <code>"30"</code></li>
<li><strong>Description</strong>:
maxK is a parameter in SimPoint algorithm used during the checkpoint's clustering stage.
<code>cpt-maxK</code> will set maxK for all benchmarks' clustering stage in checkpoints generation.
To override the maxK for specific benchmarks, refer to the <code>cpt-maxK-bmk</code> argument.</li>
</ul>
<p><arg>cpt-maxK-bmk</arg>: maxK values for specifed benchmarks in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: attr (<code>{ benchmark-name = number-in-string; ... }</code>)</li>
<li><strong>Default value</strong>: <code>{ "483.xalancbmk" = "100"; }</code></li>
<li><strong>Description</strong>:
<code>cpt-maxK-bmk</code> sets the the maxK for specifed benchmarks.
Unspecified benchmarks will use the value from <code>cpt-maxK</code>.
This attribute consists of key-value pairs where:
<ul>
<li>Key: benchmark name.</li>
<li>Value: number in a string (same format as <code>cpt-maxK</code>).</li>
</ul>
</li>
<li><strong>FAQ 1</strong>: Why set maxK of 483.xalancbmk to 100?
<ul>
<li>Setting maxK to 30 for 483.xalancbmk resulted in unstable scores.</li>
</ul>
</li>
<li><strong>FAQ 2</strong>: How to retreive the benchmark name?
<ul>
<li>
<p>Use the following commands:</p>
<pre><code class="language-bash"># Try `pname` first, if not available, use `name`.
nix-instantiate --eval -A &lt;benchmark&gt;.benchmark.pname
nix-instantiate --eval -A &lt;benchmark&gt;.benchmark.name
</code></pre>
<p>Examples:</p>
<pre><code class="language-bash"># To retreive the name of openblas benchmark, first try
nix-instantiate --eval -A openblas.benchmark.pname
# Output: "openblas"
</code></pre>
<pre><code class="language-bash"># To retreive the name of 483_xalancbmk benchmark, first try
nix-instantiate --eval -A spec2006.483_xalancbmk.benchmark.pname
# Error: attribute 'pname' in selection path 'spec2006.483_xalancbmk.benchmark.pname' not found Did you mean name?
# Second try
nix-instantiate --eval -A spec2006.483_xalancbmk.benchmark.name
# Output: "483.xalancbmk"
</code></pre>
</li>
</ul>
</li>
</ul>
<p><arg>cpt-intervals</arg>: Number of BBV interval instructions in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: number-in-string</li>
<li><strong>Default value</strong>: <code>"20000000"</code></li>
</ul>
<p><arg>cpt-simulator</arg>: Simulator used in checkpoint generation.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"qemu"</code></li>
<li><strong>Available values</strong>: <code>"qemu"</code>, <code>"nemu"</code></li>
<li><strong>Note</strong>:
Though nemu is faster than qemu, the current version of nemu is not deterministic.
Therefore, qemu is chosen as the default simulator.
For more information, refer to <a href="https://github.com/OpenXiangShan/Deterload/issues/8">OpenXiangShan/Deterload Issue #8: nemu is not deterministic</a>.</li>
</ul>
<p><arg>cpt-format</arg>: Compress format of output checkpoints.</p>
<ul>
<li><strong>Type</strong>: string</li>
<li><strong>Default value</strong>: <code>"zstd"</code></li>
<li><strong>Available value</strong>: <code>"zstd"</code>, <code>"gz"</code></li>
<li><strong>Note</strong>: nemu supports both formats; however, qemu only supports zstd format.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
